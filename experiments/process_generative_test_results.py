# 
# Process the results generated by running
#   python3 generative_tests.py
# 
# And store the output CSV in "../results/generative_results_summary.csv".
# 
# Also provide some summary information about the data being processed
# and an overview of all the error codes seen across all generative experiments.
# 

import os
import pickle
import re
import tqdm
from run_generative_tests import output_dir

results_file = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))),
                            "results", "generative_results_summary.csv")
dim_names = ("version", "d", "n", "skew", "scale", "geometry", "modifier")

if __name__ == "__main__":
    print()
    print("Storing results in:\n", repr(results_file), flush=True)
    print()

    # ----------------------------------------
    # Show a summary of the stored result data
    for path in os.listdir(output_dir):
        full_path = os.path.join(output_dir, path)
        # Load results from this experiment.
        with open(full_path, "rb") as f:
            experiment = pickle.load(f)
            # Single-time summary of the contents of experiment results.
            print()
            print("Experiment results contain:")
            for (k,v) in experiment.items():
                print(f"  {k:20s} {type(v).__name__:6s} {v.shape if hasattr(v, 'shape') else ''}")
            print()
            break
    # ----------------------------------------

    # Clear the file so that it is empty.
    with open(results_file, "w") as f:
        print("version,geometry,modifier,d,n,skew,scale,trial,error_71,other_error", file=f)

    # Process the data (and print a summary of data for the first file encountered).
    total_experiments = 0
    dimensional_summaries = {}
    for path in tqdm.tqdm(os.listdir(output_dir)):
        full_path = os.path.join(output_dir, path)
        # Load results from this experiment.
        with open(full_path, "rb") as f:
            experiment = pickle.load(f)
        # 
        # Process the experiment results.
        # Example:
        #   path = "v1-exponential_skew_ball-6_d=2_n=16384_skew=1048576_scale=1.pkl"
        #    -> version = "v1"
        #    -> modifier = "exponential"
        #    -> geometry = "ball"
        #    -> str_config = "6_d=2_n=16384_skew=1048576_scale=1.pkl"
        #    -> trial = ["6", "d=2", "n=16384", "skew=1048576", "scale=1.pkl"][0]
        #    -> config = ["6_d=2_n=16384_skew=1048576_scale=1", "pkl"][0]
        #              = "6_d=2_n=16384_skew=1048576_scale=1".split("_")
        #              = ["6", "d=2", "n=16384", "skew=1048576", "scale=1"][1:]
        #              = dict([("d","2"), ("n","16384"), ("skew","1048576"), ("scale","1")])
        #              = {"d": "2", "n": "16384", "skew": "1048576", "scale": "1"}
        #    -> d = int("2")
        #    -> n = int("16384")
        #    -> skew = float("1048576")
        #    -> scale = float("1")
        # 
        version, geometry, str_config = re.split(r"-", path, 2)
        modifier = (geometry.split("_")[:-1][:1] + [""])[0] or "identity"
        geometry = geometry.split("_")[-1]
        trial = int(str_config.split("_")[0])
        config = dict((
            kv.split("=") for kv in
            (".".join(str_config.split('.')[:-1])).split("_")[1:]
        ))
        d = int(config["d"])
        assert (d == experiment["x"].shape[1])
        n = int(config["n"])
        assert (n == experiment["x"].shape[0])
        skew = float(config["skew"])
        scale = float(config["scale"])
        # Skip skew for creators that don't have any skew option.
        if ((modifier != "identity") and (skew == 1)) or ((modifier == "identity") and (skew != 1)):
            continue
        total_experiments += 1
        # Get extrapolation related errors and other errors.
        errors = experiment["errors"]
        error_71 = errors.get(71, 0)
        if hasattr(error_71, "__len__"):
            error_71 = len(error_71)
        # Get any "other error" that occurred.
        other_error = sorted(set(errors) - {1,71})
        if len(other_error) == 1:
            other_error = other_error[0]
        else:
            other_error = 0
        # Write to file.
        with open(results_file, "a") as f:
            print(",".join(map(str, (int(version[1]), geometry, modifier, d, n, skew, scale, trial, error_71, other_error))), file=f)
        # Store some summary data too.
        for (error_code, indices) in sorted(errors.items()):
            for dim_name in dim_names:
                dim_value = locals()[dim_name]
                dimensional_summaries[dim_name] = dimensional_summaries.get(dim_name, {})
                dimensional_summaries[dim_name][
                    (dim_value, error_code)
                ] = dimensional_summaries[dim_name].get((dim_value, error_code), []) + [dict(
                    geometry=geometry,
                    trial=trial,
                    d=d,
                    n=n,
                    skew=skew,
                    scale=scale,
                )]

    # ----------------------------------
    # Show a summary of the errors along
    # each configuration axis.
    print()
    print("Total experiments:")
    print("", total_experiments)
    print()
    print("Error 71 summaries:")
    for dim_name in dim_names:
        print()
        print("", dim_name.upper())
        for ((value, error_code), configs) in sorted(dimensional_summaries[dim_name].items()):
            if (error_code != 71): continue
            print("  ", value, error_code, len(configs))
    # ----------------------------------
